name: Export all tables

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  export-all:
    runs-on: ubuntu-latest
    env:
      TABLE_NAME: ${{ secrets.TABLE_NAME }}
      OWNER: ${{ secrets.OWNER }}
      REPO_NAME: ${{ secrets.REPO_NAME }}
      DB_URL: ${{ secrets.DB_URL }}

    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PUSH_TOKEN }}

      - name: Install PostgreSQL client
        run: sudo apt-get install -y postgresql-client

      - name: Export all days to CSV
        run: |
          mkdir -p table
          days=$(psql "$DB_URL" -t -c "SELECT DISTINCT TO_CHAR(timestamp::date, 'YYYY-MM-DD') FROM ${TABLE_NAME} ORDER BY 1;")

          for day in $days; do
            echo "Exporting $day"
            psql "$DB_URL" -c "\COPY (
              SELECT *
              FROM ${TABLE_NAME}
              WHERE timestamp::date = DATE '$day'
            ) TO 'table/${day}.csv' WITH CSV HEADER"
          done

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          REMOTE="https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/${OWNER}/${REPO_NAME}.git"
          BRANCH="main"

          git clone --depth 1 --branch $BRANCH $REMOTE repo
          cp -r ./table/* repo/table/

          cd repo
          git add table/
          git commit --allow-empty -m "Update all tables"
          git push origin $BRANCH
