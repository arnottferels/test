name: Export yesterday table

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  export-yesterday:
    runs-on: ubuntu-latest
    env:
      TABLE_NAME: ${{ secrets.TABLE_NAME }}
      OWNER: ${{ secrets.OWNER }}
      REPO_NAME: ${{ secrets.REPO_NAME }}
      DB_URL: ${{ secrets.DB_URL }}

    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PUSH_TOKEN }}

      - name: Set yesterday date
        run: echo "YESTERDAY=$(date -u -d 'yesterday' +%F)" >> $GITHUB_ENV

      - name: Install PostgreSQL client
        run: sudo apt-get install -y postgresql-client

      - name: Export yesterday to CSV
        run: |
          mkdir -p table
          echo "Exporting $YESTERDAY"
          psql "$DB_URL" -c "\COPY (
            SELECT *
            FROM ${TABLE_NAME}
            WHERE timestamp::date = DATE '$YESTERDAY'
          ) TO 'table/${YESTERDAY}.csv' WITH CSV HEADER"

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          REMOTE="https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/${OWNER}/${REPO_NAME}.git"
          BRANCH="main"

          git clone --depth 1 --branch $BRANCH $REMOTE repo
          cp -r ./table/* repo/table/

          cd repo
          git add table/
          git commit --allow-empty -m "$YESTERDAY"
          git push origin $BRANCH
